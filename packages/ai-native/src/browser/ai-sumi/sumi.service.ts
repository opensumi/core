import differenceWith from 'lodash/differenceWith';

import { Injectable, Autowired } from '@opensumi/di';
import {
  CommandService,
  CommandRegistry,
  Command,
  ILogServiceClient,
  ILoggerManagerClient,
  SupportLogNamespace,
} from '@opensumi/ide-core-common';
import { IFileServiceClient } from '@opensumi/ide-file-service';

import { AiBackSerivcePath, IAiBackService, IAiBackServiceResponse } from '../../common';
import { AiChatService } from '../ai-chat.service';
import { SumiCommandPromptManager } from '../prompts/sumi.command';

const InnerCommandGroups = {
  'File and Editor Management': [
    'file.new.untitled',
    'editor.saveCurrent',
    'editor.saveUri',
    'editor.close',
    'editor.closeAllInGroup',
    'editor.closeSaved',
    'editor.closeOtherEditorsInGroup',
    'editor.closeToRight',
    'editor.revertAndClose',
    'filetree.open.file',
    'filetree.open.side',
    'filetree.open.with',
    'file.open',
    'file.save',
    'editor.document.revert',
    'editor.saveAll',
    'editor.closeAll',
    'editor.reopenClosed',
    'filetree.focus.files',
    'file.delete',
    'file.rename',
    'file.new',
    'file.folder.new',
    'filetree.cut.file',
    'filetree.paste.file',
    'filetree.revealInExplorer',
    'file.compare',
    'filetree.search.folder',
    'filetree.location',
    'filetree.location_with_editor',
    'filetree.copy.path',
    'filetree.copy.relativepath',
    'filetree.copy.file',
    'filetree.selectCurrentNode',
    'opened.editors.save.all',
    'opened.editors.close.all',
    'opened.editors.close.byGroup',
    'opened.editors.save.byGroup',
    'opened.editors.close',
    'opened.editors.open',
    'opened.editors.openToTheSide',
    'opened.editors.compare',
    'opened.editors.copyPath',
    'opened.editors.copyRelativePath',
    'opened.editors.location',
    'view-container.hide.file-explorer',
    'view-container.hide.file-opened-editor',
    'workspace.removeFolderFromWorkspace',
    'workbench.action.navigateBack',
    'workbench.action.navigateForward',
    'workbench.action.previousEditor',
    'workbench.action.previousEditorInGroup',
    'workbench.action.nextEditor',
    'workbench.action.nextEditorInGroup',
    'workbench.action.lastEditorInGroup',
    'workbench.action.openEditorAtIndex',
    'workbench.action.navigateLeft',
    'workbench.action.navigateRight',
    'workbench.action.navigateUp',
    'workbench.action.navigateDown',
    'workbench.action.navigateEditorGroups',
    '_workbench.open',
    '_workbench.diff',
    '_workbench.openWith',
    'vscode.openFolder',
    'workbench.action.showErrorsWarnings',
    'workbench.actions.view.problems',
    'workbench.action.reloadWindow',
    '_open.mergeEditor',
    'workbench.action.quickOpen',
    'toolbar.showCustomizePanel',
    'connection.start.rtt',
    'connection.stop.rtt',
    'comments.panel.action.collapse',
    'comments.thread.action.close',
    'comments.comment.action.switchCommand',
    'workbench.action.tasks.runTask',
    'workbench.action.tasks.reRunTask',
    'ai.suggest.documentation',
    'ai.chat.createNewFile',
    'ai.chat.focusLine',
    'cloudide.command.workspace.getRuntimeConfig',
    'python.datascience.notebookeditor.undocells',
    'python.datascience.notebookeditor.redocells',
    'workbench.action.showEmmetCommands',
    'merge-conflict.accept.all-current',
    'merge-conflict.accept.all-incoming',
    'merge-conflict.accept.all-both',
    'merge-conflict.accept.current',
    'merge-conflict.accept.incoming',
    'merge-conflict.accept.selection',
    'merge-conflict.accept.both',
    'merge-conflict.next',
    'merge-conflict.previous',
    'merge-conflict.compare',
    'typescript.reloadProjects',
    'javascript.reloadProjects',
    'typescript.selectTypeScriptVersion',
    'typescript.goToProjectConfig',
    'javascript.goToProjectConfig',
    'typescript.openTsServerLog',
    'typescript.restartTsServer',
    'typescript.findAllFileReferences',
    'view-container.hide.test',
    'python_tests.focus',
    'jsBrowserBreakpoints.focus',
    'jsExcludedCallers.focus',
    'TREE_VIEW_COLLAPSE_ALL_WORKER',
    '_vscode_delegate_cmd_lowwqr3c',
    'TREE_VIEW_COLLAPSE_ALL',
    '_vscode_delegate_cmd_lowwqrp7',
    '_typescript.configurePlugin',
    '_typescript.learnMoreAboutRefactorings',
    '_typescript.projectStatus',
    'js.projectStatus.command',
    '_typescript.applyCompletionCodeAction',
    '_typescript.onCompletionAccepted',
    '_typescript.applyCompletionCommand',
    '_typescript.organizeImports',
    '_typescript.applyCodeActionCommand',
    '_typescript.applyFixAllCodeAction',
    '_typescript.didApplyRefactoring',
    '_typescript.selectRefactoring',
    'emmet.expandAbbreviation',
    'git.openResource',
    'workbench.action.files.revert',
  ],
  'Version Control and Git': [
    'git.setLogLevel',
    'git.clone',
    'git.cloneRecursive',
    'git.init',
    'git.openRepository',
    'git.close',
    'git.refresh',
    'git.openChange',
    'git.openAllChanges',
    'git.openFile',
    'git.openFile2',
    'git.openHEADFile',
    'git.stage',
    'git.stageAll',
    'git.stageAllTracked',
    'git.stageAllUntracked',
    'git.stageAllMerge',
    'git.stageSelectedRanges',
    'git.revertSelectedRanges',
    'git.stageChange',
    'git.revertChange',
    'git.unstage',
    'git.unstageAll',
    'git.unstageSelectedRanges',
    'git.clean',
    'git.cleanAll',
    'git.cleanAllTracked',
    'git.cleanAllUntracked',
    'git.rename',
    'git.commit',
    'git.commitStaged',
    'git.commitEmpty',
    'git.commitStagedSigned',
    'git.commitStagedAmend',
    'git.commitAll',
    'git.commitAllSigned',
    'git.commitAllAmend',
    'git.commitNoVerify',
    'git.commitStagedNoVerify',
    'git.commitEmptyNoVerify',
    'git.commitStagedSignedNoVerify',
    'git.commitStagedAmendNoVerify',
    'git.commitAllNoVerify',
    'git.commitAllSignedNoVerify',
    'git.commitAllAmendNoVerify',
    'git.restoreCommitTemplate',
    'git.undoCommit',
    'git.checkout',
    'git.checkoutDetached',
    'git.branch',
    'git.branchFrom',
    'git.deleteBranch',
    'git.renameBranch',
    'git.merge',
    'git.rebase',
    'git.createTag',
    'git.deleteTag',
    'git.fetch',
    'git.fetchPrune',
    'git.fetchAll',
    'git.pull',
    'git.pullRebase',
    'git.pullFrom',
    'git.push',
    'git.pushForce',
    'git.pushTo',
    'git.pushToForce',
    'git.pushTags',
    'git.pushWithTags',
    'git.pushWithTagsForce',
    'git.cherryPick',
    'git.addRemote',
    'git.removeRemote',
    'git.sync',
    'git.syncRebase',
    'git.publish',
    'git.showOutput',
    'git.ignore',
    'git.revealInExplorer',
    'git.revealFileInOS.linux',
    'git.revealFileInOS.mac',
    'git.revealFileInOS.windows',
    'git.stashIncludeUntracked',
    'git.stash',
    'git.stashPop',
    'git.stashPopLatest',
    'git.stashApply',
    'git.stashApplyLatest',
    'git.stashDrop',
    'git.stashDropAll',
    'git.timeline.openDiff',
    'git.timeline.copyCommitId',
    'git.timeline.copyCommitMessage',
    'git.timeline.selectForCompare',
    'git.timeline.compareWithSelected',
    'git.rebaseAbort',
    'git.closeAllDiffEditors',
    'git.api.getRepositories',
    'git.api.getRepositoryState',
    'git.api.getRemoteSources',
    'git.acceptMerge',
    '_git.openMergeEditor',
    'git._syncAll',
    'git.openResource',
  ],
  'Debugging and Testing': [
    'debug.start',
    'debug.stop',
    'debug.next',
    'debug.prev',
    'debug.continue',
    'debug.pause',
    'debug.over',
    'debug.restart',
    'debug.breakpoints.toggle',
    'debug.breakpoints.active',
    'debug.breakpoints.deactive',
    'debug.edit.breakpoint',
    'debug.disable.breakpoint',
    'debug.enable.breakpoint',
    'debug.delete.breakpoint',
    'debug.add.conditional',
    'debug.add.logpoint',
    'debug.add.breakpoint',
    'debug.breakpointWidget.accept',
    'debug.breakpointWidget.close',
    'debug.action.runToCursor',
    'debug.action.forceRunToCursor',
    'debug.console.clear',
    'debug.console.copy',
    'debug.console.copyALl',
    'debug.console.collapseAll',
    'debug.console.keybing.enter.evaluate',
    'debug.console.input.down.arrow',
    'debug.console.input.up.arrow',
    'debug.console.filter.input.focus',
    'debug.variables.setValue',
    'debug.variables.copy',
    'debug.evaluate.copy',
    'debug.addToWatchExpressions',
    'debug.variables.view.memory',
    'debug.callstack.restart.frame',
    'debug.callstack.copy',
    'debug.watch.add',
    'debug.watch.collapseAll',
    'debug.watch.removeAll',
    'debug.watch.remove',
    'debug.watch.edit',
    'debug.watch.copyValue',
    'testing.run.test',
    'testing.debug.test',
    'testing.goto.test',
    'testing.peek.test.error',
    'testing.peek.test.close',
    'testing.runCurrentFile',
    'testing.debugCurrentFile',
    'testing.goToPreviousMessage',
    'testing.goToNextMessage',
    'testing.clearTestResults',
    'testing.openMessageInEditor',
    'testing.refresshTests',
    'testing.runAll',
    'testing.debugAll',
    'workbench.action.debug.stepInto',
    'workbench.action.debug.stepOver',
    'workbench.action.debug.stepOut',
    'workbench.action.debug.continue',
    'workbench.action.debug.run',
    'workbench.action.debug.start',
    'workbench.action.debug.pause',
    'workbench.action.debug.restart',
    'workbench.action.debug.stop',
  ],
  'Terminal and Command Line': [
    'terminal.search',
    'terminal.split',
    'terminal.clear',
    'terminal.add',
    'terminal.toggleTerminal',
    'terminal.search.next',
    'terminal.remove',
    'terminal.openWithPath',
    'terminal.tabRename',
    'terminal.selectAllContent',
    'terminal.clearContent',
    'terminal.clearAllContent',
    'terminal.selectTypeZsh',
    'terminal.selectTypeBash',
    'terminal.selectTypeSh',
    'terminal.selectTypePowerShell',
    'terminal.selectTypeCMD',
    'terminal.moreSettings',
    'terminal.copy',
    'terminal.paste',
    'terminal.selectAll',
    'terminal.relaunch',
    'workbench.action.terminal.focusNextPane',
    'workbench.action.terminal.focusPreviousPane',
    'terminal.killProcess',
    'TerminalProfilesCommand:bash:bash',
    'TerminalProfilesCommand:zsh:zsh',
    'TerminalProfilesCommand:ms-vscode.js-debug:extension.js-debug.debugTerminal',
    'filetree.openTerminalWithPath',
  ],
  'User Interface and Layout Management': [
    'activity.bar.toggle.left',
    'activity.bar.toggle.right',
    'activity.bar.toggle.explorer',
    'activity.bar.activate.more.explorer',
    'workbench.view.explorer',
    'container.show.explorer',
    'container.hide.explorer',
    'container.toggle.explorer',
    'activity.bar.toggle.search',
    'activity.bar.activate.more.search',
    'workbench.view.search',
    'container.show.search',
    'container.hide.search',
    'container.toggle.search',
    'activity.bar.toggle.scm',
    'activity.bar.activate.more.scm',
    'workbench.view.scm',
    'container.show.scm',
    'container.hide.scm',
    'container.toggle.scm',
    'activity.bar.toggle.extension',
    'activity.bar.activate.more.extension',
    'workbench.view.extension',
    'container.show.extension',
    'container.hide.extension',
    'container.toggle.extension',
    'activity.bar.toggle.debug',
    'activity.bar.activate.more.debug',
    'workbench.view.debug',
    'container.show.debug',
    'container.hide.debug',
    'container.toggle.debug',
    'view-container.hide.explorer',
    'view-container.hide.scm',
    'view-container.hide.scm_view',
    'view-container.hide.debug-welcome',
    'view-container.hide.extension',
    'activity.bar.toggle.bottom',
    'main-layout.bottom-panel.expand',
    'main-layout.bottom-panel.retract',
    'main-layout.bottom-panel.toggle',
    'activity.bar.toggle.terminal',
    'activity.bar.activate.more.terminal',
    'workbench.view.terminal',
    'container.show.terminal',
    'container.hide.terminal',
    'container.toggle.terminal',
    'activity.bar.toggle.output',
    'activity.bar.activate.more.output',
    'workbench.view.output',
    'container.show.output',
    'container.hide.output',
    'container.toggle.output',
    'activity.bar.toggle.debug-console',
    'activity.bar.activate.more.debug-console',
    'workbench.view.debug-console',
    'container.show.debug-console',
    'container.hide.debug-console',
    'container.toggle.debug-console',
    'activity.bar.toggle.markers',
    'activity.bar.activate.more.markers',
    'workbench.view.markers',
    'container.show.markers',
    'container.hide.markers',
    'container.toggle.markers',
    'view-container.hide.markers',
    'view-container.hide.output',
    'view-container.hide.debug-console',
    'view-container.hide.terminal',
    'view-container.hide.debug-console-view',
    'activity.bar.toggle.ai_chat',
    'activity.bar.activate.more.ai_chat',
    'workbench.view.ai_chat',
    'container.show.ai_chat',
    'container.hide.ai_chat',
    'container.toggle.ai_chat',
    'view-container.hide.ai_chat',
    'main-layout.left-panel.hide',
    'main-layout.left-panel.show',
    'main-layout.left-panel.toggle',
    'main-layout.right-panel.hide',
    'main-layout.right-panel.show',
    'main-layout.right-panel.toggle',
    'workbench.action.closeSidebar',
    'main-layout.bottom-panel.show',
    'main-layout.bottom-panel.hide',
    'main-layout.bottom-panel.is-visible',
    'main-layout.left-panel.is-visible',
    'main-layout.right-panel.is-visible',
    'main-layout.panel.size.set',
    'view.outward.right-panel.hide',
    'view.outward.right-panel.show',
    'view.outward.left-panel.hide',
    'view.outward.left-panel.show',
    'layout.action.Maximizeeditor',
    'layout.action.openView',
    'editor.splitToLeft',
    'editor.splitToRight',
    'editor.moveGroup',
    'editor.focusActiveEditorGroup',
    'editor.splitToTop',
    'editor.splitToBottom',
    'editor.evenEditorGroups',
    'editor.closeOtherGroup',
    'theme.toggle',
    'theme.icon.toggle',
    'view-container.hide.file-explorer',
    'view-container.hide.file-opened-editor',
    'view-container.hide.search',
    'view-container.hide.outline-view',
    'view-container.hide.debug',
    'statusbar.changeBackgroundColor',
    'statusbar.changeColor',
    'statusbar.addElement',
    'statusbar.toggleElement',
    'workbench.action.closePanel',
    'workbench.action.maximizeEditor',
    'workbench.action.closeActiveEditor',
    'workbench.action.revertAndCloseActiveEditor',
    'workbench.action.splitEditorRight',
    'workbench.action.splitEditorDown',
    'workbench.action.splitEditor',
    'workbench.action.splitEditorOrthogonal',
    'workbench.action.focusActiveEditorGroup',
    'workbench.action.toggleSidebarVisibility',
    'workbench.files.action.focusFilesExplorer',
    'toggle.diff.renderSideBySide',
    'workbench.scm.action.setTreeViewMode',
    'workbench.scm.action.setListViewMode',
    'revealInExplorer',
    'workbench.action.terminal.clear',
    'workbench.action.terminal.focus',
    'workbench.action.terminal.toggleTerminal',
    'workbench.action.terminal.new',
    'editor.action.fontZoomIn',
    'editor.action.fontZoomOut',
    'editor.action.fontZoomReset',
  ],
  'Code Editing and Refactoring': [
    'editor.undo',
    'editor.redo',
    'editor.selectAll',
    'editor.action.formatDocument',
    'editor.action.formatSelection',
    'editor.action.indentationToSpaces',
    'editor.action.indentationToTabs',
    'editor.action.indentUsingTabs',
    'editor.action.indentUsingSpaces',
    'editor.action.detectIndentation',
    'editor.action.reindentlines',
    'editor.action.reindentselectedlines',
    'editor.action.smartSelect.expand',
    'editor.action.smartSelect.shrink',
    'editor.action.forceRetokenize',
    'editor.action.toggleTabFocusMode',
    'editor.action.unicodeHighlight.disableHighlightingOfAmbiguousCharacters',
    'editor.action.unicodeHighlight.disableHighlightingOfInvisibleCharacters',
    'editor.action.unicodeHighlight.disableHighlightingOfNonBasicAsciiCharacters',
    'editor.action.unicodeHighlight.showExcludeOptions',
    'editor.action.wordHighlight.next',
    'editor.action.wordHighlight.prev',
    'editor.action.wordHighlight.trigger',
    'editor.emmet.action.wrapWithAbbreviation',
    'editor.emmet.action.removeTag',
    'editor.emmet.action.updateTag',
    'editor.emmet.action.matchTag',
    'editor.emmet.action.balanceIn',
    'editor.emmet.action.balanceOut',
    'editor.emmet.action.prevEditPoint',
    'editor.emmet.action.nextEditPoint',
    'editor.emmet.action.mergeLines',
    'editor.emmet.action.selectPrevItem',
    'editor.emmet.action.selectNextItem',
    'editor.emmet.action.splitJoinTag',
    'editor.emmet.action.toggleComment',
    'editor.emmet.action.evaluateMathExpression',
    'editor.emmet.action.updateImageSize',
    'editor.emmet.action.incrementNumberByOneTenth',
    'editor.emmet.action.incrementNumberByOne',
    'editor.emmet.action.incrementNumberByTen',
    'editor.emmet.action.decrementNumberByOneTenth',
    'editor.emmet.action.decrementNumberByOne',
    'editor.emmet.action.decrementNumberByTen',
    'editor.emmet.action.reflectCSSValue',
    'editor.action.clipboardCutAction',
    'editor.action.clipboardCopyAction',
    'editor.action.clipboardPasteAction',
    'editor.action.clipboardCopyWithSyntaxHighlightingAction',
    'editor.action.commentLine',
    'editor.action.addCommentLine',
    'editor.action.removeCommentLine',
    'editor.action.blockComment',
    'editor.action.addSelectionToNextFindMatch',
    'editor.action.addSelectionToPreviousFindMatch',
    'editor.action.moveSelectionToNextFindMatch',
    'editor.action.moveSelectionToPreviousFindMatch',
    'editor.action.selectHighlights',
    'editor.action.changeAll',
    'editor.action.rename',
    'editor.action.transformToUppercase',
    'editor.action.transformToLowercase',
    'editor.action.transformToSnakecase',
    'editor.action.transformToTitlecase',
    'editor.action.transformToKebabcase',
    'editor.action.insertLineBefore',
    'editor.action.insertLineAfter',
    'editor.action.deleteLines',
    'editor.action.indentLines',
    'editor.action.outdentLines',
    'editor.action.duplicateSelection',
    'editor.action.copyLinesUpAction',
    'editor.action.copyLinesDownAction',
    'editor.action.moveLinesUpAction',
    'editor.action.moveLinesDownAction',
    'editor.action.sortLinesAscending',
    'editor.action.sortLinesDescending',
    'editor.action.trimTrailingWhitespace',
    'editor.action.deleteAllLeft',
    'editor.action.deleteAllRight',
    'editor.action.joinLines',
    'editor.action.transpose',
    'editor.action.toggleWordWrap',
    'editor.action.formatDocument.multiple',
    'editor.action.formatSelection.multiple',
    'dialog.ensure',
    'noop',
    'undo',
    'default:undo',
    'redo',
    'default:redo',
    'editor.action.selectAll',
    '_moveTo',
    '_moveToSelect',
    'columnSelect',
    'cursorColumnSelectLeft',
    'cursorColumnSelectRight',
    'cursorColumnSelectUp',
    'cursorColumnSelectPageUp',
    'cursorColumnSelectDown',
    'cursorColumnSelectPageDown',
    'cursorMove',
    'cursorLeft',
    'cursorLeftSelect',
    'cursorRight',
    'cursorRightSelect',
    'cursorUp',
    'cursorUpSelect',
    'cursorPageUp',
    'cursorPageUpSelect',
    'cursorDown',
    'cursorDownSelect',
    'cursorPageDown',
    'cursorPageDownSelect',
    'createCursor',
    '_lastCursorMoveToSelect',
    'cursorHome',
    'cursorHomeSelect',
    'cursorLineStart',
    'cursorLineStartSelect',
    'cursorEnd',
    'cursorEndSelect',
    'cursorLineEnd',
    'cursorLineEndSelect',
    'cursorTop',
    'cursorTopSelect',
    'cursorBottom',
    'cursorBottomSelect',
    'editorScroll',
    'scrollLineUp',
    'scrollPageUp',
    'scrollEditorTop',
    'scrollLineDown',
    'scrollPageDown',
    'scrollEditorBottom',
    '_wordSelect',
    '_wordSelectDrag',
    'lastCursorWordSelect',
    '_lineSelect',
    '_lineSelectDrag',
    'lastCursorLineSelect',
    'lastCursorLineSelectDrag',
    'cancelSelection',
    'removeSecondaryCursors',
    'revealLine',
    'setSelection',
    'lineBreakInsert',
    'outdent',
    'tab',
    'deleteLeft',
    'deleteRight',
    'default:type',
    'type',
    'default:replacePreviousChar',
    'replacePreviousChar',
    'default:compositionType',
    'compositionType',
    'default:compositionStart',
    'compositionStart',
    'default:compositionEnd',
    'compositionEnd',
    'default:paste',
    'paste',
    'default:cut',
    'cut',
    'editor.action.diffReview.next',
    'editor.action.diffReview.prev',
    '_provideDocumentSemanticTokensLegend',
    '_provideDocumentSemanticTokens',
    '_provideDocumentRangeSemanticTokensLegend',
    '_provideDocumentRangeSemanticTokens',
    'getContextKeyInfo',
    '_generateContextKeyInfo',
    'editor.cancelOperation',
    '_executeFormatRangeProvider',
    '_executeFormatDocumentProvider',
    '_executeFormatOnTypeProvider',
    '_executeCodeActionProvider',
    'editor.action.showContextMenu',
    'history.showPrevious',
    'history.showNext',
    '_executeCompletionItemProvider',
    'jumpToNextSnippetPlaceholder',
    'jumpToPrevSnippetPlaceholder',
    'leaveSnippet',
    'acceptSnippet',
    'editor.action.triggerSuggest',
    'acceptSelectedSuggestion',
    'acceptAlternativeSelectedSuggestion',
    'acceptSelectedSuggestionOnEnter',
    'hideSuggestWidget',
    'selectNextSuggestion',
    'selectNextPageSuggestion',
    'selectLastSuggestion',
    'selectPrevSuggestion',
    'selectPrevPageSuggestion',
    'selectFirstSuggestion',
    'toggleSuggestionDetails',
    'toggleExplainMode',
    'toggleSuggestionFocus',
    'insertBestCompletion',
    'insertNextSuggestion',
    'insertPrevSuggestion',
    'editor.action.resetSuggestSize',
    'editor.action.setSelectionAnchor',
    'editor.action.goToSelectionAnchor',
    'editor.action.selectFromAnchorToCursor',
    'editor.action.cancelSelectionAnchor',
    'editor.action.selectToBracket',
    'editor.action.jumpToBracket',
    'editor.action.moveCarretLeftAction',
    'editor.action.moveCarretRightAction',
    'editor.action.transposeLetters',
    'leaveEditorMessage',
    'hideCodeActionWidget',
    'selectPrevCodeAction',
    'selectNextCodeAction',
    'acceptSelectedCodeAction',
    'previewSelectedCodeAction',
    'editor.action.quickFix',
    'editor.action.refactor',
    'editor.action.refactor.preview',
    'editor.action.sourceAction',
    'editor.action.organizeImports',
    'editor.action.autoFix',
    'editor.action.fixAll',
    'editor.action.codeAction',
    '_executeCodeLensProvider',
    'codelens.showLensesInCurrentLine',
    '_executeDocumentColorProvider',
    '_executeColorPresentationProvider',
    'togglePeekWidgetFocus',
    'goToNextReference',
    'goToPreviousReference',
    'goToNextReferenceFromEmbeddedEditor',
    'goToPreviousReferenceFromEmbeddedEditor',
    'closeReferenceSearchEditor',
    'closeReferenceSearch',
    'revealReference',
    'openReferenceToSide',
    'openReference',
    'editor.gotoNextSymbolFromResult',
    'editor.gotoNextSymbolFromResult.cancel',
    '_executeDefinitionProvider',
    '_executeTypeDefinitionProvider',
    '_executeDeclarationProvider',
    '_executeReferenceProvider',
    '_executeImplementationProvider',
    'editor.action.findReferences',
    'editor.action.showReferences',
    'editor.action.goToLocations',
    'editor.action.peekLocations',
    'editor.action.openDeclarationToTheSide',
    'editor.action.revealDefinitionAside',
    'editor.action.previewDeclaration',
    'editor.action.inlineSuggest.trigger',
    'editor.action.inlineSuggest.showNext',
    'editor.action.inlineSuggest.showPrevious',
    'editor.action.inlineSuggest.commit',
    'editor.action.inlineSuggest.hide',
    'editor.action.inPlaceReplace.up',
    'editor.action.inPlaceReplace.down',
    'expandLineSelection',
    'editor.action.removeDuplicateLines',
    'deleteAllLeft',
    'deleteAllRight',
    'editor.action.linkedEditing',
    'editor.action.insertCursorAbove',
    'editor.action.insertCursorBelow',
    'editor.action.insertCursorAtEndOfEachLineSelected',
    'editor.action.addCursorsToBottom',
    'editor.action.addCursorsToTop',
    'editor.action.focusNextCursor',
    'editor.action.focusPreviousCursor',
    'editor.action.toggleStickyScroll',
    'editor.action.smartSelect.grow',
    'editor.action.format',
    'editor.action.gotoLine',
    'editor.toggleWordWrap',
    'editor.diff.accept',
    'editor.diff.revert',
    'editor.autoSave',
    'editor.action.copyPath',
    'editor.action.copyRelativePath',
    'editor.opentype',
    'editor.action.fontZoomIn',
    'editor.action.fontZoomOut',
    'editor.action.fontZoomReset',
    'editor.componentUndo',
    'editor.componentRedo',
    'editor.tokenize.test',
    'editor.goToGroup',
    'editor.changeLanguage',
    'editor.changeEncoding',
    'editor.changeEol',
    'editor.focus',
    'editor.navigateNext',
    'editor.navigatePrevious',
    'editor.navigateUp',
    'editor.navigateDown',
    'editor.navigateLeft',
    'editor.navigateRight',
    'editor.previousInGroup',
    'editor.nextInGroup',
    'editor.next',
    'editor.previous',
    'editor.lastInGroup',
    'editor.openEditorAtIndex',
    'editor.action.openLink',
  ],
  'Search and Navigation': [
    'workbench.action.gotoSymbol',
    'editor.action.startFindReplaceAction',
    'editor.actions.findWithArgs',
    'actions.findWithSelection',
    'editor.action.nextMatchFindAction',
    'editor.action.previousMatchFindAction',
    'editor.action.nextSelectionMatchFindAction',
    'editor.action.previousSelectionMatchFindAction',
    'closeFindWidget',
    'toggleFindCaseSensitive',
    'toggleFindWholeWord',
    'toggleFindRegex',
    'toggleFindInSelection',
    'togglePreserveCase',
    'editor.action.replaceOne',
    'editor.action.replaceAll',
    'editor.action.selectAllMatches',
    'editor.unfold',
    'editor.unfoldRecursively',
    'editor.fold',
    'editor.foldRecursively',
    'editor.foldAll',
    'editor.unfoldAll',
    'editor.foldAllBlockComments',
    'editor.foldAllMarkerRegions',
    'editor.unfoldAllMarkerRegions',
    'editor.foldAllExcept',
    'editor.unfoldAllExcept',
    'editor.toggleFold',
    'editor.gotoParentFold',
    'editor.gotoPreviousFold',
    'editor.gotoNextFold',
    'editor.createFoldingRangeFromSelection',
    'editor.removeManualFoldingRanges',
    'editor.foldLevel1',
    'editor.foldLevel2',
    'editor.foldLevel3',
    'editor.foldLevel4',
    'editor.foldLevel5',
    'editor.foldLevel6',
    'editor.foldLevel7',
    'editor.gotoLine',
    'editor.action.goToDeclaration',
    'editor.action.revealDefinition',
    'editor.action.peekDefinition',
    'editor.action.revealDeclaration',
    'editor.action.peekDeclaration',
    'editor.action.goToTypeDefinition',
    'editor.action.peekTypeDefinition',
    'editor.action.goToImplementation',
    'editor.action.peekImplementation',
    'editor.action.goToReferences',
    'editor.action.referenceSearch.trigger',
    'editor.action.showHover',
    'editor.action.marker.next',
    'editor.action.marker.prev',
    'editor.action.marker.nextInFiles',
    'editor.action.marker.prevInFiles',
    'editor.action.quickCommand',
    'editor.action.quickOutline',
    'editor.action.quickView',
    'editor.workspaceSymbol.quickopen',
    'editor.workspaceSymbolClass.quickopen',
    'content-search.openSearch',
    'filetree.search.folder',
    'filetree.next',
    'filetree.prev',
    'filetree.collapse',
    'filetree.expand',
    'filetree.toggleOrOpen',
    'search.menu.replace',
    'search.menu.replaceAll',
    'search.menu.hide',
    'search.menu.copy',
    'search.menu.copyAll',
    'search.menu.copyPath',
    'editor.action.quickOutline',
    'editor.action.quickView',
    'editor.action.triggerParameterHints',
    'closeParameterHints',
    'showPrevParameterHint',
    'showNextParameterHint',
    'editor.action.inlineSuggest.trigger',
    'editor.action.inlineSuggest.showNext',
    'editor.action.inlineSuggest.showPrevious',
    'editor.action.inlineSuggest.commit',
    'editor.action.inlineSuggest.hide',
    '_executeHoverProvider',
    'closeMarkersNavigation',
    'actions.find',
    '_executeDocumentSymbolProvider',
    '_executeInlayHintProvider',
    'cursorWordStartLeft',
    'cursorWordEndLeft',
    'cursorWordLeft',
    'cursorWordStartLeftSelect',
    'cursorWordEndLeftSelect',
    'cursorWordLeftSelect',
    'cursorWordStartRight',
    'cursorWordEndRight',
    'cursorWordRight',
    'cursorWordStartRightSelect',
    'cursorWordEndRightSelect',
    'cursorWordRightSelect',
    'cursorWordAccessibilityLeft',
    'cursorWordAccessibilityLeftSelect',
    'cursorWordAccessibilityRight',
    'cursorWordAccessibilityRightSelect',
    'deleteWordStartLeft',
    'deleteWordEndLeft',
    'deleteWordLeft',
    'deleteWordStartRight',
    'deleteWordEndRight',
    'deleteWordRight',
    'deleteInsideWord',
    'cursorWordPartStartLeft',
    'cursorWordPartStartLeftSelect',
    'deleteWordPartLeft',
    'deleteWordPartRight',
    'cursorWordPartLeft',
    'cursorWordPartLeftSelect',
    'cursorWordPartRight',
    'cursorWordPartRightSelect',
    'editor.goForward',
    'editor.focusIfNotActivateElement',
    'editor.goBack',
    'editor.openUri',
    'editor.openUris',
    'editor.compare',
    'editor.open.mergeEditor',
    'editor.mergeEditor.reset',
    'editor.getCurrent',
    'editor.getCurrentResource',
    'editor.pinCurrent',
    'editor.copyCurrentPath',
    'workbench.action.gotoSymbol',
    'workbench.action.findInFiles',
    'workbench.action.showAllSymbols',
    '_executeDocumentHighlights',
    '_executeLinkProvider',
    'cancelLinkedEditingInput',
    '_executeLinkedEditingProvider',
    'acceptRenameInput',
    'acceptRenameInputWithPreview',
    'cancelRenameInput',
    '_executeDocumentRenameProvider',
    '_executePrepareRename',
    '_executeSelectionRangeProvider',
    'cursorUndo',
    'cursorRedo',
    '_executePrepareCallHierarchy',
    '_executeProvideIncomingCalls',
    '_executeProvideOutgoingCalls',
    '_executePrepareTypeHierarchy',
    '_executeProvideSupertypes',
    '_executeProvideSubtypes',
    'filetree.collapse.all',
    'filetree.refresh.all',
    'filetree.files.filter_toggle',
    'filetree.files.filter_open',
    'filetree.quitFilterMode',
    'file-search.refresh',
    'file-search.clean',
    'search.getRecentSearchWordCmd',
    'search.getBackRecentSearchWordCmd',
    'output.channel.clear',
    'marker.action.showErrorsWarnings',
    'marker.action.toggleShowErrorsWarnings',
    'workspace.addFolderToWorkspace',
    'workspace.saveWorkspaceAsFile',
    'outline.collapse.all',
    'outline.follow.cursor',
    'outline.sort.kind',
    'outline.sort.name',
    'outline.sort.position',
    'refactor-preview.clear.edits',
    'refactor-preview.apply.edits',
    'OPEN_DIRTY_DIFF_WIDGET',
    'CLOSE_DIRTY_DIFF_WIDGET',
    'workbench.action.compareEditor.previousChange',
    'workbench.action.compareEditor.nextChange',
    'vscode.open',
    'vscode.openWith',
    'vscode.diff',
    'walkthroughs.get.started',
    'workbench.action.files.saveAll',
    'workbench.action.closeAllEditors',
    'workbench.action.eventEditorWidths',
    'workbench.action.closeEditorsInOtherGroups',
    'workbench.action.closeUnmodifiedEditors',
    'workbench.action.closeOtherEditors',
    'workbench.action.files.newUntitledFile',
    'workbench.action.files.save',
    'renameFile',
    'workbench.action.openSettings',
    'workbench.action.openGlobalSettings',
    'workbench.action.openSettingsJson',
    'workbench.action.openGlobalKeybindings',
    'workbench.action.selectTheme',
    '_vscode_delegate_cmd_lowzug5h',
    '_vscode_delegate_cmd_lowzugai',
    'core.launchConfiguration.open',
    'debug.breakpoints.remove.all',
    'core.environment.variable',
    'ext.restart',
    'extension.getDescription',
    'setContext',
    'reload_window',
    'sumi-extension:ext-host-event',
    'copyFilePath',
    'copyRelativeFilePath',
  ],
  'Extensions and Customization': [
    'activity.bar.toggle.extension',
    'activity.bar.activate.more.extension',
    'workbench.view.extension',
    'container.show.extension',
    'container.hide.extension',
    'container.toggle.extension',
    'view-container.hide.extension',
    'extension.js-debug.prettyPrint',
    'extension.js-debug.toggleSkippingFile',
    'extension.js-debug.addCustomBreakpoints',
    'extension.js-debug.removeCustomBreakpoint',
    'extension.js-debug.removeAllCustomBreakpoints',
    'extension.pwa-node-debug.attachNodeProcess',
    'extension.js-debug.npmScript',
    'extension.js-debug.createDebuggerTerminal',
    'extension.js-debug.startProfile',
    'extension.js-debug.stopProfile',
    'extension.js-debug.revealPage',
    'extension.js-debug.debugLink',
    'extension.js-debug.createDiagnostics',
    'extension.node-debug.startWithStopOnEntry',
    'extension.js-debug.openEdgeDevTools',
    'extension.js-debug.callers.add',
    'extension.js-debug.callers.remove',
    'extension.js-debug.callers.removeAll',
    'extension.js-debug.callers.goToCaller',
    'extension.js-debug.callers.gotToTarget',
    'vscode-icons.activateIcons',
    'vscode-icons.regenerateIcons',
    'vscode-icons.ngPreset',
    'vscode-icons.nestPreset',
    'vscode-icons.jsPreset',
    'vscode-icons.tsPreset',
    'vscode-icons.jsonPreset',
    'vscode-icons.hideFoldersPreset',
    'vscode-icons.foldersAllDefaultIconPreset',
    'vscode-icons.hideExplorerArrowsPreset',
    'vscode-icons.restoreIcons',
    'vscode-icons.resetProjectDetectionDefaults',
    'workbench.action.showRuntimeExtensions',
    'workbench.action.extensionHostProfiler.start',
    'workbench.action.extensionHostProfiler.stop',
    'sumi-extension.toolbar.btn.setState',
    'sumi-extension.toolbar.btn.setContext',
    'sumi-extension.toolbar.btn.connectHandle',
    'sumi-extension.toolbar.select.setState',
    'sumi-extension.toolbar.select.setOptions',
    'sumi-extension.toolbar.select.setSelect',
    'sumi-extension.toolbar.select.connectHandle',
    'sumi-extension.toolbar.showPopover',
    'sumi-extension.toolbar.hidePopover',
  ],
  'Data Science and Notebooks': [
    'python.analysis.clearCache',
    'python.enableSourceMapSupport',
    'python.sortImports',
    'python.startREPL',
    'python.createTerminal',
    'python.buildWorkspaceSymbols',
    'python.openTestNodeInEditor',
    'python.runTestNode',
    'python.debugTestNode',
    'python.runtests',
    'python.debugtests',
    'python.execInTerminal',
    'python.execInTerminal-icon',
    'python.setInterpreter',
    'python.switchOffInsidersChannel',
    'python.switchToDailyChannel',
    'python.switchToWeeklyChannel',
    'python.refactorExtractVariable',
    'python.refactorExtractMethod',
    'python.viewTestOutput',
    'python.viewLanguageServerOutput',
    'python.viewOutput',
    'python.selectAndRunTestMethod',
    'python.selectAndDebugTestMethod',
    'python.selectAndRunTestFile',
    'python.runCurrentTestFile',
    'python.runFailedTests',
    'python.discoverTests',
    'python.discoveringTests',
    'python.stopTests',
    'python.configureTests',
    'python.execSelectionInTerminal',
    'python.execSelectionInDjangoShell',
    'python.goToPythonObject',
    'python.setLinter',
    'python.enableLinting',
    'python.runLinting',
  ],
  'Accessibility and Help': [
    'editor.action.showAccessibilityHelp',
    'closeAccessibilityHelp',
    'editor.action.inspectTokens',
    'editor.action.showHover',
    'editor.action.showDefinitionPreviewHover',
    'editor.action.quickCommand',
    'editor.action.quickOutline',
    'editor.action.quickView',
    'core.about',
    'core.keymaps.open',
    'keymaps.open.source',
    'keyboard.chooseKeyboardLayout',
    'ai.explain.terminal',
    'ai.explain.debug',
    'ai.run.debug',
    'ai.inline.chat.visible',
    'authentication.noAccounts',
    'preference.setting.glyphMargin.edit',
    'preference.open.user',
    'preference.open.workspace',
    'preference.open.source',
    'preference.input.focus',
    'core.openpreference',
    'workbench.preferences.locate',
    'variable.list',
  ],
};

@Injectable()
export class AiSumiService {
  private commandGroups = InnerCommandGroups;
  // for split command, too much will out of prompt tokens
  protected commandRequestStep = 50;

  @Autowired(AiBackSerivcePath)
  aiBackService: IAiBackService;

  @Autowired(CommandService)
  protected readonly commandService: CommandService;

  @Autowired(CommandRegistry)
  protected readonly commandRegistryService: CommandRegistry;

  @Autowired(AiChatService)
  protected readonly aiChatService: AiChatService;

  @Autowired(IFileServiceClient)
  protected fileService: IFileServiceClient;

  @Autowired(SumiCommandPromptManager)
  protected promptManager: SumiCommandPromptManager;

  @Autowired(ILoggerManagerClient)
  private readonly loggerManagerClient: ILoggerManagerClient;

  protected logger: ILogServiceClient;
  // 用来记录查找失败的，因为用 any，在 catch 里不好处理，加个变量记录下
  private findCommandRequestErrorCode = 0;

  constructor() {
    this.logger = this.loggerManagerClient.getLogger(SupportLogNamespace.Browser);
  }

  async requestToModel(prompt: string, model?: string) {
    return this.aiBackService.request(prompt, { model });
  }

  async classifyCommand() {
    const allCommand = this.commandRegistryService.getCommands();
    const innerCommands = Object.keys(this.commandGroups).reduce(
      (array, curGroup) => array.concat(this.commandGroups[curGroup]),
      [] as string[],
    );
    const unGroupCommands = differenceWith(
      allCommand,
      innerCommands,
      (command, innerCommand) => command.id === innerCommand,
    );

    if (unGroupCommands.length) {
      const partCommands = Array.from(
        { length: Math.round(unGroupCommands.length / this.commandRequestStep) || 1 },
        (_, index) => index,
      ).map((i) => unGroupCommands.slice(i * this.commandRequestStep, (i + 1) * this.commandRequestStep));

      for (const commands of partCommands) {
        await this.requestForClassifyCommand(commands);
      }
    }
  }

  async requestForClassifyCommand(commands: Command[]) {
    const prompt = this.promptManager.groupCommand(commands.map((c) => c.id).join(','));
    const groupReply = await this.requestToModel(prompt);

    const groupReg = new RegExp(
      `\\[(?<groupName>${Object.keys(this.commandGroups).join('|')})\\]:\\s?(?<commandList>.*)`,
    );

    const groupArray = groupReply.data?.split('\n') || [];
    groupArray.forEach((groupLine) => {
      const match = groupReg.exec(groupLine);
      if (match && match.groups?.commandList) {
        const { groupName, commandList } = match.groups || {};
        const commandArray = commandList.split(',');
        this.commandGroups[groupName] = this.commandGroups[groupName]
          ? this.commandGroups[groupName].concat(commandArray)
          : [commandArray];
      }
    });
  }

  public async searchCommand(input: string): Promise<IAiBackServiceResponse<Command>> {
    this.findCommandRequestErrorCode = 0;
    try {
      return this.searchGroup(input);
    } catch {
      return { errorCode: 1 };
    }
  }

  public async searchGroup(input: string) {
    const enPrompt = this.promptManager.searchGroup(input, { useCot: true });

    const groupReply = await this.requestToModel(enPrompt);

    if (groupReply?.errorCode) {
      return { errorCode: groupReply.errorCode, errorMsg: groupReply.errorMsg };
    }

    const groups = Object.keys(this.commandGroups);
    const groupReg = new RegExp(`(?<group>${groups.join('|')})`);
    const match = groupReg.exec(groupReply.data || '');
    const group = match && match.groups?.group;

    return this.findCommand(input, group);
  }

  public async findCommand(input: string, group?: string | null): Promise<IAiBackServiceResponse<Command>> {
    const commandsInGroup = this.commandGroups[group || ''];

    if (!commandsInGroup) {
      return { errorCode: 0 };
    }

    const commands = this.commandRegistryService
      .getCommands()
      .filter((c) => commandsInGroup.includes(c.delegate || c.id));

    const partCommands = Array.from(
      { length: Math.round(commands.length / this.commandRequestStep) },
      (_, index) => index,
    ).map((i) => commands.slice(i * this.commandRequestStep, (i + 1) * this.commandRequestStep));

    try {
      const command = await Promise.any(partCommands.map((c) => this.requestCommand(c, input)));

      return { data: commands.find((c) => c.id === command?.data) };
    } catch (e) {
      this.logger.error('Find command failed: ', e.message);
      return { errorCode: this.findCommandRequestErrorCode };
    }
  }

  private async requestCommand(commands: Command[], question: string) {
    const prompt = this.promptManager.findCommand({
      commands: commands
        .map((c) => `{${c.delegate || c.id}}-{${c.labelLocalized?.localized! || c.label || ''}}`)
        .join('\n'),
      question,
    });

    const commandReply = await this.requestToModel(prompt);

    if (commandReply.errorCode) {
      this.findCommandRequestErrorCode = commandReply.errorCode;
    }

    const answerCommand = this.matchCommand(commandReply.data || '');

    if (answerCommand && commands.find((c) => c.id === answerCommand)) {
      return { data: answerCommand };
    }

    await Promise.reject('Command not found');
  }

  private matchCommand(answer: string): string {
    const commandReg = /`(?<command>\S+)`/;
    const command = commandReg.exec(answer);

    return command?.groups?.command || '';
  }
}
